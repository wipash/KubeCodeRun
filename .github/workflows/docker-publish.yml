name: Docker Images Build

on:
  push:
    tags:
      - '*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_all:
        description: 'Build all images regardless of changes'
        required: false
        default: false
        type: boolean

jobs:
  # ==================== Detect Changes ====================
  changes:
    runs-on: ubuntu-24.04
    outputs:
      api: ${{ steps.filter.outputs.api }}
      sidecar: ${{ steps.filter.outputs.sidecar }}
      python: ${{ steps.filter.outputs.python }}
      javascript: ${{ steps.filter.outputs.javascript }}
      go: ${{ steps.filter.outputs.go }}
      java: ${{ steps.filter.outputs.java }}
      c-cpp: ${{ steps.filter.outputs.c-cpp }}
      php: ${{ steps.filter.outputs.php }}
      rust: ${{ steps.filter.outputs.rust }}
      r: ${{ steps.filter.outputs.r }}
      fortran: ${{ steps.filter.outputs.fortran }}
      d: ${{ steps.filter.outputs.d }}
      force_all: ${{ github.event.inputs.force_all == 'true' }}
      image_tag: ${{ steps.tag.outputs.image_tag }}
      is_release: ${{ steps.tag.outputs.is_release }}
      previous_tag: ${{ steps.prev_tag.outputs.tag_name }}
      version: ${{ steps.version.outputs.version }}
      # Skip Docker builds for fork PRs (no permission to push to upstream registry)
      is_fork: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == true }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0  # Need full history for tag comparison and version

      - name: Get version from git
        id: version
        run: |
          VERSION=$(pipx run setuptools-scm)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Get previous tag for comparison
        id: prev_tag
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          CURRENT_TAG="${{ github.ref_name }}"
          # Get all tags sorted by version, find the one before current
          PREV_TAG=$(git tag --sort=-v:refname | grep -A1 "^${CURRENT_TAG}$" | tail -n1)
          if [[ "$PREV_TAG" == "$CURRENT_TAG" ]] || [[ -z "$PREV_TAG" ]]; then
            # No previous tag found, compare to initial commit
            echo "No previous tag found, comparing to initial commit"
            echo "base=$(git rev-list --max-parents=0 HEAD)" >> $GITHUB_OUTPUT
            echo "tag_name=" >> $GITHUB_OUTPUT
          else
            echo "Comparing $CURRENT_TAG to previous tag $PREV_TAG"
            echo "base=$PREV_TAG" >> $GITHUB_OUTPUT
            echo "tag_name=$PREV_TAG" >> $GITHUB_OUTPUT
          fi

      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          # For tag pushes, compare to previous tag; otherwise use default (base branch)
          base: ${{ steps.prev_tag.outputs.base || '' }}
          filters: |
            api:
              - 'src/**'
              - 'Dockerfile'
              - 'pyproject.toml'
              - 'uv.lock'
            sidecar:
              - 'docker/sidecar/**'
            python:
              - 'docker/python.Dockerfile'
            javascript:
              - 'docker/nodejs.Dockerfile'
            go:
              - 'docker/go.Dockerfile'
            java:
              - 'docker/java.Dockerfile'
            c-cpp:
              - 'docker/c-cpp.Dockerfile'
            php:
              - 'docker/php.Dockerfile'
            rust:
              - 'docker/rust.Dockerfile'
            r:
              - 'docker/r.Dockerfile'
            fortran:
              - 'docker/fortran.Dockerfile'
            d:
              - 'docker/d.Dockerfile'

      - name: Set image tag
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            SHORT_SHA=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
            echo "image_tag=dev-${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
            echo "image_tag=dev-${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "is_release=false" >> $GITHUB_OUTPUT
          else
            echo "image_tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "is_release=true" >> $GITHUB_OUTPUT
          fi

  # ==================== Build Jobs ====================
  # Note: All build jobs skip when is_fork == 'true' (fork PRs can't push to upstream registry)
  api:
    needs: changes
    if: |
      needs.changes.outputs.is_fork != 'true' &&
      (needs.changes.outputs.api == 'true' || needs.changes.outputs.force_all == 'true')
    uses: ./.github/workflows/docker-build-reusable.yml
    with:
      image_name: kubecoderun-api
      dockerfile: Dockerfile
      context: .
      image_tag: ${{ needs.changes.outputs.image_tag }}
      is_release: ${{ needs.changes.outputs.is_release == 'true' }}
      version: ${{ needs.changes.outputs.version }}

  sidecar:
    needs: changes
    if: |
      needs.changes.outputs.is_fork != 'true' &&
      (needs.changes.outputs.sidecar == 'true' || needs.changes.outputs.force_all == 'true')
    uses: ./.github/workflows/docker-build-reusable.yml
    with:
      image_name: kubecoderun-sidecar
      dockerfile: docker/sidecar/Dockerfile
      context: docker/sidecar
      image_tag: ${{ needs.changes.outputs.image_tag }}
      is_release: ${{ needs.changes.outputs.is_release == 'true' }}
      version: ${{ needs.changes.outputs.version }}

  python:
    needs: changes
    if: |
      needs.changes.outputs.is_fork != 'true' &&
      (needs.changes.outputs.python == 'true' || needs.changes.outputs.force_all == 'true')
    uses: ./.github/workflows/docker-build-reusable.yml
    with:
      image_name: kubecoderun-python
      dockerfile: docker/python.Dockerfile
      context: docker
      image_tag: ${{ needs.changes.outputs.image_tag }}
      is_release: ${{ needs.changes.outputs.is_release == 'true' }}

  javascript:
    needs: changes
    if: |
      needs.changes.outputs.is_fork != 'true' &&
      (needs.changes.outputs.javascript == 'true' || needs.changes.outputs.force_all == 'true')
    uses: ./.github/workflows/docker-build-reusable.yml
    with:
      image_name: kubecoderun-javascript
      dockerfile: docker/nodejs.Dockerfile
      context: docker
      image_tag: ${{ needs.changes.outputs.image_tag }}
      is_release: ${{ needs.changes.outputs.is_release == 'true' }}

  typescript:
    needs: changes
    if: |
      needs.changes.outputs.is_fork != 'true' &&
      (needs.changes.outputs.javascript == 'true' || needs.changes.outputs.force_all == 'true')
    uses: ./.github/workflows/docker-build-reusable.yml
    with:
      image_name: kubecoderun-typescript
      dockerfile: docker/nodejs.Dockerfile
      context: docker
      image_tag: ${{ needs.changes.outputs.image_tag }}
      is_release: ${{ needs.changes.outputs.is_release == 'true' }}

  go:
    needs: changes
    if: |
      needs.changes.outputs.is_fork != 'true' &&
      (needs.changes.outputs.go == 'true' || needs.changes.outputs.force_all == 'true')
    uses: ./.github/workflows/docker-build-reusable.yml
    with:
      image_name: kubecoderun-go
      dockerfile: docker/go.Dockerfile
      context: docker
      image_tag: ${{ needs.changes.outputs.image_tag }}
      is_release: ${{ needs.changes.outputs.is_release == 'true' }}

  java:
    needs: changes
    if: |
      needs.changes.outputs.is_fork != 'true' &&
      (needs.changes.outputs.java == 'true' || needs.changes.outputs.force_all == 'true')
    uses: ./.github/workflows/docker-build-reusable.yml
    with:
      image_name: kubecoderun-java
      dockerfile: docker/java.Dockerfile
      context: docker
      image_tag: ${{ needs.changes.outputs.image_tag }}
      is_release: ${{ needs.changes.outputs.is_release == 'true' }}

  c-cpp:
    needs: changes
    if: |
      needs.changes.outputs.is_fork != 'true' &&
      (needs.changes.outputs.c-cpp == 'true' || needs.changes.outputs.force_all == 'true')
    uses: ./.github/workflows/docker-build-reusable.yml
    with:
      image_name: kubecoderun-c-cpp
      dockerfile: docker/c-cpp.Dockerfile
      context: docker
      image_tag: ${{ needs.changes.outputs.image_tag }}
      is_release: ${{ needs.changes.outputs.is_release == 'true' }}

  php:
    needs: changes
    if: |
      needs.changes.outputs.is_fork != 'true' &&
      (needs.changes.outputs.php == 'true' || needs.changes.outputs.force_all == 'true')
    uses: ./.github/workflows/docker-build-reusable.yml
    with:
      image_name: kubecoderun-php
      dockerfile: docker/php.Dockerfile
      context: docker
      image_tag: ${{ needs.changes.outputs.image_tag }}
      is_release: ${{ needs.changes.outputs.is_release == 'true' }}

  rust:
    needs: changes
    if: |
      needs.changes.outputs.is_fork != 'true' &&
      (needs.changes.outputs.rust == 'true' || needs.changes.outputs.force_all == 'true')
    uses: ./.github/workflows/docker-build-reusable.yml
    with:
      image_name: kubecoderun-rust
      dockerfile: docker/rust.Dockerfile
      context: docker
      image_tag: ${{ needs.changes.outputs.image_tag }}
      is_release: ${{ needs.changes.outputs.is_release == 'true' }}

  r:
    needs: changes
    if: |
      needs.changes.outputs.is_fork != 'true' &&
      (needs.changes.outputs.r == 'true' || needs.changes.outputs.force_all == 'true')
    uses: ./.github/workflows/docker-build-reusable.yml
    with:
      image_name: kubecoderun-r
      dockerfile: docker/r.Dockerfile
      context: docker
      image_tag: ${{ needs.changes.outputs.image_tag }}
      is_release: ${{ needs.changes.outputs.is_release == 'true' }}

  fortran:
    needs: changes
    if: |
      needs.changes.outputs.is_fork != 'true' &&
      (needs.changes.outputs.fortran == 'true' || needs.changes.outputs.force_all == 'true')
    uses: ./.github/workflows/docker-build-reusable.yml
    with:
      image_name: kubecoderun-fortran
      dockerfile: docker/fortran.Dockerfile
      context: docker
      image_tag: ${{ needs.changes.outputs.image_tag }}
      is_release: ${{ needs.changes.outputs.is_release == 'true' }}

  d:
    needs: changes
    if: |
      needs.changes.outputs.is_fork != 'true' &&
      (needs.changes.outputs.d == 'true' || needs.changes.outputs.force_all == 'true')
    uses: ./.github/workflows/docker-build-reusable.yml
    with:
      image_name: kubecoderun-d
      dockerfile: docker/d.Dockerfile
      context: docker
      image_tag: ${{ needs.changes.outputs.image_tag }}
      is_release: ${{ needs.changes.outputs.is_release == 'true' }}

  # ==================== Retag Unchanged Images (for releases) ====================
  # These jobs run when an image didn't change but we still want it tagged with the new version

  retag-api:
    needs: changes
    if: |
      needs.changes.outputs.is_release == 'true' &&
      needs.changes.outputs.previous_tag != '' &&
      needs.changes.outputs.api != 'true' &&
      needs.changes.outputs.force_all != 'true'
    uses: ./.github/workflows/docker-retag-reusable.yml
    with:
      image_name: kubecoderun-api
      new_tag: ${{ needs.changes.outputs.image_tag }}
      previous_tag: ${{ needs.changes.outputs.previous_tag }}

  retag-sidecar:
    needs: changes
    if: |
      needs.changes.outputs.is_release == 'true' &&
      needs.changes.outputs.previous_tag != '' &&
      needs.changes.outputs.sidecar != 'true' &&
      needs.changes.outputs.force_all != 'true'
    uses: ./.github/workflows/docker-retag-reusable.yml
    with:
      image_name: kubecoderun-sidecar
      new_tag: ${{ needs.changes.outputs.image_tag }}
      previous_tag: ${{ needs.changes.outputs.previous_tag }}

  retag-python:
    needs: changes
    if: |
      needs.changes.outputs.is_release == 'true' &&
      needs.changes.outputs.previous_tag != '' &&
      needs.changes.outputs.python != 'true' &&
      needs.changes.outputs.force_all != 'true'
    uses: ./.github/workflows/docker-retag-reusable.yml
    with:
      image_name: kubecoderun-python
      new_tag: ${{ needs.changes.outputs.image_tag }}
      previous_tag: ${{ needs.changes.outputs.previous_tag }}

  retag-javascript:
    needs: changes
    if: |
      needs.changes.outputs.is_release == 'true' &&
      needs.changes.outputs.previous_tag != '' &&
      needs.changes.outputs.javascript != 'true' &&
      needs.changes.outputs.force_all != 'true'
    uses: ./.github/workflows/docker-retag-reusable.yml
    with:
      image_name: kubecoderun-javascript
      new_tag: ${{ needs.changes.outputs.image_tag }}
      previous_tag: ${{ needs.changes.outputs.previous_tag }}

  retag-typescript:
    needs: changes
    if: |
      needs.changes.outputs.is_release == 'true' &&
      needs.changes.outputs.previous_tag != '' &&
      needs.changes.outputs.javascript != 'true' &&
      needs.changes.outputs.force_all != 'true'
    uses: ./.github/workflows/docker-retag-reusable.yml
    with:
      image_name: kubecoderun-typescript
      new_tag: ${{ needs.changes.outputs.image_tag }}
      previous_tag: ${{ needs.changes.outputs.previous_tag }}

  retag-go:
    needs: changes
    if: |
      needs.changes.outputs.is_release == 'true' &&
      needs.changes.outputs.previous_tag != '' &&
      needs.changes.outputs.go != 'true' &&
      needs.changes.outputs.force_all != 'true'
    uses: ./.github/workflows/docker-retag-reusable.yml
    with:
      image_name: kubecoderun-go
      new_tag: ${{ needs.changes.outputs.image_tag }}
      previous_tag: ${{ needs.changes.outputs.previous_tag }}

  retag-java:
    needs: changes
    if: |
      needs.changes.outputs.is_release == 'true' &&
      needs.changes.outputs.previous_tag != '' &&
      needs.changes.outputs.java != 'true' &&
      needs.changes.outputs.force_all != 'true'
    uses: ./.github/workflows/docker-retag-reusable.yml
    with:
      image_name: kubecoderun-java
      new_tag: ${{ needs.changes.outputs.image_tag }}
      previous_tag: ${{ needs.changes.outputs.previous_tag }}

  retag-c-cpp:
    needs: changes
    if: |
      needs.changes.outputs.is_release == 'true' &&
      needs.changes.outputs.previous_tag != '' &&
      needs.changes.outputs.c-cpp != 'true' &&
      needs.changes.outputs.force_all != 'true'
    uses: ./.github/workflows/docker-retag-reusable.yml
    with:
      image_name: kubecoderun-c-cpp
      new_tag: ${{ needs.changes.outputs.image_tag }}
      previous_tag: ${{ needs.changes.outputs.previous_tag }}

  retag-php:
    needs: changes
    if: |
      needs.changes.outputs.is_release == 'true' &&
      needs.changes.outputs.previous_tag != '' &&
      needs.changes.outputs.php != 'true' &&
      needs.changes.outputs.force_all != 'true'
    uses: ./.github/workflows/docker-retag-reusable.yml
    with:
      image_name: kubecoderun-php
      new_tag: ${{ needs.changes.outputs.image_tag }}
      previous_tag: ${{ needs.changes.outputs.previous_tag }}

  retag-rust:
    needs: changes
    if: |
      needs.changes.outputs.is_release == 'true' &&
      needs.changes.outputs.previous_tag != '' &&
      needs.changes.outputs.rust != 'true' &&
      needs.changes.outputs.force_all != 'true'
    uses: ./.github/workflows/docker-retag-reusable.yml
    with:
      image_name: kubecoderun-rust
      new_tag: ${{ needs.changes.outputs.image_tag }}
      previous_tag: ${{ needs.changes.outputs.previous_tag }}

  retag-r:
    needs: changes
    if: |
      needs.changes.outputs.is_release == 'true' &&
      needs.changes.outputs.previous_tag != '' &&
      needs.changes.outputs.r != 'true' &&
      needs.changes.outputs.force_all != 'true'
    uses: ./.github/workflows/docker-retag-reusable.yml
    with:
      image_name: kubecoderun-r
      new_tag: ${{ needs.changes.outputs.image_tag }}
      previous_tag: ${{ needs.changes.outputs.previous_tag }}

  retag-fortran:
    needs: changes
    if: |
      needs.changes.outputs.is_release == 'true' &&
      needs.changes.outputs.previous_tag != '' &&
      needs.changes.outputs.fortran != 'true' &&
      needs.changes.outputs.force_all != 'true'
    uses: ./.github/workflows/docker-retag-reusable.yml
    with:
      image_name: kubecoderun-fortran
      new_tag: ${{ needs.changes.outputs.image_tag }}
      previous_tag: ${{ needs.changes.outputs.previous_tag }}

  retag-d:
    needs: changes
    if: |
      needs.changes.outputs.is_release == 'true' &&
      needs.changes.outputs.previous_tag != '' &&
      needs.changes.outputs.d != 'true' &&
      needs.changes.outputs.force_all != 'true'
    uses: ./.github/workflows/docker-retag-reusable.yml
    with:
      image_name: kubecoderun-d
      new_tag: ${{ needs.changes.outputs.image_tag }}
      previous_tag: ${{ needs.changes.outputs.previous_tag }}
