name: Retag Docker Image (Reusable)

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
        description: 'Image name (e.g., kubecoderun-sidecar)'
      new_tag:
        required: true
        type: string
        description: 'New tag to apply'
      previous_tag:
        required: true
        type: string
        description: 'Previous tag to copy from'

jobs:
  retag:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
    steps:
      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Retag image
        run: |
          OWNER="${{ github.repository_owner }}"
          OWNER_LC="${OWNER,,}"
          IMAGE="ghcr.io/${OWNER_LC}/${{ inputs.image_name }}"
          OLD_TAG="${{ inputs.previous_tag }}"
          NEW_TAG="${{ inputs.new_tag }}"

          echo "Retagging ${IMAGE}:${OLD_TAG} -> ${IMAGE}:${NEW_TAG}"

          # Use imagetools to create new tags pointing to the same digests
          # This works directly with multi-arch manifests
          docker buildx imagetools create \
            --tag "${IMAGE}:${NEW_TAG}" \
            "${IMAGE}:${OLD_TAG}"

          # Also create platform-specific tags for consistency
          docker buildx imagetools create \
            --tag "${IMAGE}:${NEW_TAG}-linux-amd64" \
            "${IMAGE}:${OLD_TAG}-linux-amd64"

          docker buildx imagetools create \
            --tag "${IMAGE}:${NEW_TAG}-linux-arm64" \
            "${IMAGE}:${OLD_TAG}-linux-arm64"

          echo "Successfully retagged ${IMAGE}:${OLD_TAG} as ${IMAGE}:${NEW_TAG}"
