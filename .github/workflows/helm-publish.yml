name: Helm Chart Publish

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # v4.3.1

      - name: Set chart version from tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Use version from Chart.yaml for manual runs
            VERSION=$(grep '^version:' helm-deployments/kubecoderun/Chart.yaml | awk '{print $2}')
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
          else
            # Use tag name (strip 'v' prefix if present)
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
          fi
          # Set lowercase owner for GHCR
          OWNER="${{ github.repository_owner }}"
          echo "owner=${OWNER,,}" >> $GITHUB_OUTPUT

      - name: Update Chart.yaml version
        run: |
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.version }}/" helm-deployments/kubecoderun/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.version }}\"/" helm-deployments/kubecoderun/Chart.yaml
          cat helm-deployments/kubecoderun/Chart.yaml

      - name: Lint Helm chart
        run: helm lint helm-deployments/kubecoderun

      - name: Package Helm chart
        run: |
          helm package helm-deployments/kubecoderun --destination ./helm-package
          ls -la ./helm-package

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push to GitHub Container Registry
        run: |
          CHART_PACKAGE=$(ls ./helm-package/*.tgz)
          helm push "${CHART_PACKAGE}" oci://ghcr.io/${{ steps.version.outputs.owner }}/charts
