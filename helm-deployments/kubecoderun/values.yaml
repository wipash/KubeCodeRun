# KubeCodeRun Helm Chart Values

# API Deployment Configuration
replicaCount: 1

image:
  repository: aronmuon/kubecoderun-api
  pullPolicy: IfNotPresent
  tag: "latest"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# Service Account for the API pod
serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations: {}
podSecurityContext:
  fsGroup: 1000

securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false

service:
  type: ClusterIP
  port: 8000

ingress:
  enabled: false
  className: ""
  annotations: {}
  hosts:
    - host: kubecoderun.local
      paths:
        - path: /
          pathType: Prefix
  tls: []

resources:
  limits:
    cpu: 1000m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 256Mi

# Health check probes
# Startup probe handles slow-starting containers (pool warming takes ~60-90s)
startupProbe:
  enabled: true
  httpGet:
    path: /health
    port: http
  failureThreshold: 30
  periodSeconds: 5
  # 30 * 5 = 150 seconds max startup time

livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 30
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /ready
    port: http
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 3

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80

nodeSelector: {}
tolerations: []
affinity: {}

# External Dependencies
redis:
  # Reference an existing Kubernetes Secret containing REDIS_URL
  # When set, the url/host/port/password/db fields below are ignored
  # Expected secret key: REDIS_URL (full connection string)
  existingSecret: ""
  # External Redis URL (required unless existingSecret is set)
  url: "redis://redis:6379/0"
  # Or specify individual fields
  host: ""
  port: 6379
  password: ""
  db: 0

minio:
  # Reference an existing Kubernetes Secret containing S3 credentials
  # When set, the accessKey/secretKey fields below are ignored
  # Expected secret keys: MINIO_ACCESS_KEY, MINIO_SECRET_KEY
  existingSecret: ""
  endpoint: "minio:9000"
  accessKey: ""
  secretKey: ""
  secure: false
  bucket: "kubecoderun-files"
  # Use IAM role for authentication (IRSA on EKS)
  # When true, accessKey and secretKey are not required
  useIAM: false
  # AWS region (required when useIAM is true)
  region: ""

# API Configuration
api:
  # Reference an existing Kubernetes Secret containing API keys
  # When set, the apiKey/masterApiKey fields below are ignored
  # Expected secret keys: API_KEY, and optionally MASTER_API_KEY
  existingSecret: ""
  apiKey: "" # Will be auto-generated if empty
  masterApiKey: "" # For admin operations
  debug: false
  logLevel: "INFO"
  logFormat: "json"

# Execution Configuration
execution:
  # Namespace for execution pods (defaults to Release.Namespace if empty)
  namespace: ""

  # Cleanup configuration for pool pods on helm uninstall
  cleanup:
    enabled: true

  # Image registry configuration
  # Images are named: {imageRegistry}-{language}:{imageTag}
  # e.g., aronmuon/kubecoderun-python:latest
  imageRegistry: "aronmuon/kubecoderun"
  imageTag: "latest"
  # Image pull policy for execution pods (IfNotPresent, Always, Never)
  # Use "Always" when using :latest tags to ensure fresh images
  imagePullPolicy: "Always"

  # Service account for execution pods (with pod/job create permissions)
  serviceAccount:
    create: true
    name: "kubecoderun-executor"
    annotations: {}

  # Sidecar container configuration
  sidecar:
    image: aronmuon/kubecoderun-sidecar:latest
    port: 8080

  # Per-language pool configuration
  # poolSize > 0: warm pods maintained
  # poolSize = 0: use Jobs (cold start)
  languages:
    python:
      image: aronmuon/kubecoderun-python:latest
      poolSize: 5
    javascript:
      image: aronmuon/kubecoderun-javascript:latest
      poolSize: 2
    typescript:
      image: aronmuon/kubecoderun-typescript:latest
      poolSize: 0
    go:
      image: aronmuon/kubecoderun-go:latest
      poolSize: 0
    java:
      image: aronmuon/kubecoderun-java:latest
      poolSize: 0
    rust:
      image: aronmuon/kubecoderun-rust:latest
      poolSize: 0
    c:
      image: aronmuon/kubecoderun-c-cpp:latest
      poolSize: 0
    cpp:
      image: aronmuon/kubecoderun-c-cpp:latest
      poolSize: 0
    php:
      image: aronmuon/kubecoderun-php:latest
      poolSize: 0
    r:
      image: aronmuon/kubecoderun-r:latest
      poolSize: 0
    fortran:
      image: aronmuon/kubecoderun-fortran:latest
      poolSize: 0
    d:
      image: aronmuon/kubecoderun-d:latest
      poolSize: 0

  # Job settings (for languages with poolSize=0)
  jobs:
    ttlSecondsAfterFinished: 60
    activeDeadlineSeconds: 300

  # Pod security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    readOnlyRootFilesystem: false

  # Resource limits for execution pods
  resources:
    limits:
      cpu: "1"
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # Maximum execution time in seconds
  maxExecutionTime: 30

  # Network isolation
  networkPolicy:
    enabled: true
    denyEgress: true

# State Persistence Configuration
state:
  enabled: true
  ttlSeconds: 7200
  maxSizeMb: 50

# RBAC for execution pods
rbac:
  create: true

# AWS Secrets Store CSI Driver Configuration
# When enabled, secrets are fetched from AWS Secrets Manager instead of Kubernetes secrets
secretsStore:
  enabled: false
  provider: "aws" # Currently only AWS is supported

  # The ARN of the secret in AWS Secrets Manager containing the environment variables
  # This secret should contain: REDIS_URL, MINIO_ENDPOINT, MINIO_BUCKET, AWS_REGION, etc.
  secretArn: ""

  # Objects to fetch from AWS Secrets Manager
  # Each object maps a secret ARN to environment variables
  objects: []
  # Example:
  # - secretArn: "arn:aws:secretsmanager:us-west-2:123456789:secret:my-secret"
  #   objectAlias: "kubecoderun-env"
  #   jmesPath:
  #     - path: "REDIS_URL"
  #       objectAlias: "REDIS_URL"
  #     - path: "MINIO_BUCKET"
  #       objectAlias: "MINIO_BUCKET"

  # Secret objects to sync as Kubernetes secrets (for envFrom)
  # These map the jmesPath aliases to Kubernetes secret keys
  secretObjects: []
  # Example:
  # - objectName: "REDIS_URL"
  #   key: "REDIS_URL"
  # - objectName: "MINIO_BUCKET"
  #   key: "MINIO_BUCKET"
